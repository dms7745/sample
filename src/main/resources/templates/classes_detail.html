<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout}">

<head>
    <title th:text="${classes != null ? classes.title : '강의 상세보기'}">강의 상세보기</title>
    <style>
        .star-rating { color: #ffc107; }
        .star-rating .bi-star { color: #dee2e6; }
        .review-card { border-left: 4px solid #0d6efd; }
        .rating-input { display: none; }
        .rating-label { cursor: pointer; font-size: 1.5rem; color: #dee2e6; }
        .rating-label:hover, .rating-label:hover ~ .rating-label,
        .rating-input:checked ~ .rating-label { color: #ffc107; }
        .rating-container { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
    </style>
</head>

<body>
    <th:block layout:fragment="content">
        <div class="container my-4">

            <!-- 강의 헤더 -->
            <div class="mb-4 pb-3 border-bottom">
                <h2 class="fw-bold mb-3">
                    <span th:text="${classes?.title}">강의 제목</span>
                    <span class="badge bg-info ms-2 align-middle fs-6" th:text="${classes?.level?.levelName ?: 'N/A'}"
                          th:classappend="${classes?.level == null ? 'bg-secondary' :
                              (classes.level.levelId == 1 ? 'bg-info' :
                              (classes.level.levelId == 2 ? 'bg-primary' : 'bg-danger'))}">레벨</span>
                </h2>
                <div class="row small text-muted">
                    <div class="col-md-3 mb-2">
                        <i class="bi bi-person-fill me-1"></i>
                        <strong>강사:</strong> <span th:text="${classes?.user?.userName}">강사명</span>
                    </div>
                    <div class="col-md-3 mb-2">
                        <i class="bi bi-calendar-check me-1"></i>
                        <strong>등록일:</strong> <span th:text="${classes?.classesCdate != null ? #temporals.format(classes.classesCdate, 'yyyy-MM-dd') : ''}">등록일</span>
                    </div>
                    <div class="col-md-3 mb-2">
                        <i class="bi bi-people-fill me-1"></i>
                        <span th:text="|수강생 ${enrollmentCount}명|">수강생 0명</span>
                    </div>
                    <div class="col-md-3 mb-2 text-md-end">
                        <span class="star-rating">
                            <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                <i th:class="${i <= averageRating ? 'bi bi-star-fill' : 'bi bi-star'}"></i>
                            </th:block>
                        </span>
                        <span th:text="|${averageRating} (${reviewCount}개 리뷰)|">0.0 (0개 리뷰)</span>
                    </div>
                </div>
            </div>

            <!-- 강의 이미지 및 소개 -->
            <div class="row mb-5">
                <div class="col-lg-12">
                    <div th:if="${classes.classesImg != null}" class="mb-4 text-center bg-light p-3 rounded">
                        <img th:src="${classes.classesImg}" class="img-fluid rounded shadow-sm"
                             style="max-height: 500px; object-fit: contain;" alt="강의 이미지">
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title border-bottom pb-2 mb-3 fw-bold">강의 소개</h5>
                            <p class="card-text" style="white-space: pre-wrap; line-height: 1.8;"
                               th:text="${classes.classesContent}">강의 내용</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 수강 버튼 영역 -->
            <div class="d-flex justify-content-end align-items-center mb-5">
                <div th:if="${isEnrolled or #authorization.expression('hasRole(''ROLE_ADMIN'')') or #authorization.expression('hasRole(''ROLE_INSTRUCTOR'')')}">
                    <a th:href="@{|/classes/watch/${classes.classesId}|}" class="btn btn-success btn-lg shadow-sm">
                        <i class="bi bi-play-circle-fill me-1"></i> 강의 영상 시청하기
                    </a>
                    <a th:if="${isEnrolled}" th:href="@{/question/create(classesId=${classes.classesId})}"
                       class="btn btn-dark ms-2">
                        <i class="bi bi-play-circle-fill"></i> 질문하기
                    </a>
                    <span th:if="${isEnrolled and isCompleted}" class="btn btn-lg btn-outline-success ms-2 disabled">
                        <i class="bi bi-check-circle-fill me-1"></i> 수강 완료
                    </span>
                </div>

                <div th:unless="${isEnrolled or #authorization.expression('hasRole(''ROLE_ADMIN'')') or #authorization.expression('hasRole(''ROLE_INSTRUCTOR'')')}">
                    <form sec:authorize="isAuthenticated()" th:action="@{|/enrollment/create/${classes.classesId}|}" method="post">
                        <button type="submit" class="btn btn-primary btn-lg shadow-sm"
                                onclick="return confirm('이 강의를 수강 신청하시겠습니까?');">
                            <i class="bi bi-journal-check me-1"></i> 수강신청 하기
                        </button>
                    </form>
                    <a sec:authorize="!isAuthenticated()" th:href="@{/user/login}" class="btn btn-primary btn-lg shadow-sm">
                        <i class="bi bi-box-arrow-in-right me-1"></i> 로그인 후 수강신청
                    </a>
                </div>
            </div>

            <!-- 리뷰 섹션 -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-chat-square-text me-2"></i>수강 후기
                        <span class="badge bg-primary ms-2" th:text="${reviewCount}">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- 리뷰 작성 폼 (수강 완료한 사용자만) -->
                    <div th:if="${canWriteReview}" class="mb-4 p-3 bg-light rounded">
                        <h6 class="fw-bold mb-3">후기 작성하기</h6>
                        <form th:action="@{|/review/create/${classes.classesId}|}" method="post">
                            <div class="mb-3">
                                <label class="form-label">별점</label>
                                <div class="rating-container">
                                    <input type="radio" name="rating" value="5" id="star5" class="rating-input" required>
                                    <label for="star5" class="rating-label"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" name="rating" value="4" id="star4" class="rating-input">
                                    <label for="star4" class="rating-label"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" name="rating" value="3" id="star3" class="rating-input">
                                    <label for="star3" class="rating-label"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" name="rating" value="2" id="star2" class="rating-input">
                                    <label for="star2" class="rating-label"><i class="bi bi-star-fill"></i></label>
                                    <input type="radio" name="rating" value="1" id="star1" class="rating-input">
                                    <label for="star1" class="rating-label"><i class="bi bi-star-fill"></i></label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">후기 내용</label>
                                <textarea name="content" class="form-control" rows="3" 
                                          placeholder="강의에 대한 솔직한 후기를 남겨주세요." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">후기 등록</button>
                        </form>
                    </div>

                    <!-- 리뷰 목록 -->
                    <div th:if="${reviews != null and !reviews.isEmpty()}">
                        <div th:each="review : ${reviews}" class="card review-card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong th:text="${review.user.userName}">작성자</strong>
                                        <span class="star-rating ms-2">
                                            <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                                <i th:class="${i <= review.rating ? 'bi bi-star-fill' : 'bi bi-star'}"></i>
                                            </th:block>
                                        </span>
                                    </div>
                                    <small class="text-muted"><span th:if="${review.modifiedDate != null and review.modifiedDate != review.createdDate}" th:text="${#temporals.format(review.modifiedDate, 'yyyy-MM-dd HH:mm') + ' (수정됨)'}"></span><span th:unless="${review.modifiedDate != null and review.modifiedDate != review.createdDate}" th:text="${#temporals.format(review.createdDate, 'yyyy-MM-dd HH:mm')}"></span></small>
                                </div>
                                <p class="mb-2" style="white-space: pre-wrap;" th:text="${review.content}">리뷰 내용</p>
                                
                                <!-- 본인 리뷰인 경우 수정/삭제 버튼 -->
                                <div th:if="${currentUser != null and currentUser.uno == review.user.uno}" class="text-end">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" 
                                            th:attr="data-bs-toggle='collapse', data-bs-target='#editForm' + ${review.reviewId}">
                                        수정
                                    </button>
                                    <form th:action="@{|/review/delete/${review.reviewId}|}" method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                onclick="return confirm('리뷰를 삭제하시겠습니까?');">삭제</button>
                                    </form>
                                </div>
                                
                                <!-- 수정 폼 (숨김) -->
                                <div th:if="${currentUser != null and currentUser.uno == review.user.uno}" 
                                     class="collapse mt-3" th:id="'editForm' + ${review.reviewId}">
                                    <form th:action="@{|/review/edit/${review.reviewId}|}" method="post" class="bg-light p-3 rounded">
                                        <div class="mb-2">
                                            <label class="form-label">별점</label>
                                            <select name="rating" class="form-select form-select-sm" style="width: auto;">
                                                <option th:each="r : ${#numbers.sequence(1, 5)}" th:value="${r}" 
                                                        th:text="${r} + '점'" th:selected="${r == review.rating}">1점</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <textarea name="content" class="form-control form-control-sm" rows="2" 
                                                      th:text="${review.content}"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-primary">수정 완료</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 리뷰가 없을 때 -->
                    <div th:if="${reviews == null or reviews.isEmpty()}" class="text-center py-4 text-muted">
                        <i class="bi bi-chat-square display-4"></i>
                        <p class="mt-2">아직 등록된 후기가 없습니다.</p>
                    </div>
                </div>
            </div>

            <!-- 수정/삭제 버튼 (작성자 또는 관리자) -->
            <div sec:authorize="isAuthenticated()"
                 th:if="${classes != null and classes.user != null and (#authentication.name == classes.user.userId or #authorization.expression('hasRole(''ROLE_ADMIN'')'))}"
                 class="text-end border-top pt-3">
                <a th:href="@{|/classes/edit/${classes.classesId}|}" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-pencil-square me-1"></i> 강의 수정
                </a>
                <form th:action="@{|/classes/delete/${classes.classesId}|}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-outline-danger"
                            onclick="return confirm('정말 이 강의를 삭제하시겠습니까? 복구할 수 없습니다.');">
                        <i class="bi bi-trash me-1"></i> 삭제
                    </button>
                </form>
            </div>

            <div class="mt-3">
                <a th:href="@{/classes/list}" class="text-decoration-none text-muted">
                    <i class="bi bi-arrow-left"></i> 목록으로 돌아가기
                </a>
            </div>

        </div>
    </th:block>
</body>
</html>
